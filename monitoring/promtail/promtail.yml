# Promtail Configuration for Portfolio Microservices
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Docker containers logs
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s

    relabel_configs:
      # Only collect logs from containers with specific labels
      - source_labels: ['__meta_docker_container_label_logging']
        regex: 'promtail'
        action: keep

      # Extract service name from container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container_name'

      # Add service label
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'service'

      # Add project label
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: 'project'

      # Add container ID
      - source_labels: ['__meta_docker_container_id']
        target_label: 'container_id'

      # Add environment label if exists
      - source_labels: ['__meta_docker_container_label_environment']
        target_label: 'environment'

    pipeline_stages:
    # No JSON parsing here - send raw logs to Loki
    # JSON parsing will be done in Grafana queries instead
    # This allows non-JSON logs to be stored without errors

# Alternative: File-based log collection (if not using Docker)
# - job_name: file-logs
#   static_configs:
#     - targets:
#         - localhost
#       labels:
#         job: portfolio-services
#         __path__: /var/log/portfolio/*.log
#
#   pipeline_stages:
#     - json:
#         expressions:
#           level: level
#           timestamp: time
#           message: msg
#     - labels:
#         level:
#     - timestamp:
#         source: timestamp
#         format: RFC3339Nano
