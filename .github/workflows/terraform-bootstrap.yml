# Terraform Bootstrap Workflow
# Creates S3 bucket and DynamoDB table for Terraform state storage
# ONLY run this ONCE before first terraform apply

name: Terraform Bootstrap

on:
  workflow_dispatch:
    inputs:
      confirm_bootstrap:
        description: 'Type "bootstrap" to confirm first-time setup'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  bootstrap:
    name: Bootstrap Terraform Backend
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_bootstrap }}" != "bootstrap" ]; then
            echo "Error: Confirmation required. Type 'bootstrap' to proceed."
            exit 1
          fi

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create S3 bucket for Terraform state
        run: |
          BUCKET_NAME="portfolio-terraform-state-prod"
          REGION="${{ secrets.AWS_REGION }}"

          # Check if bucket exists
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Bucket $BUCKET_NAME already exists"
          else
            echo "Creating S3 bucket $BUCKET_NAME in region $REGION"

            if [ "$REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION"
            else
              aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION" \
                --create-bucket-configuration LocationConstraint="$REGION"
            fi

            # Enable versioning
            aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" \
              --versioning-configuration Status=Enabled

            # Enable encryption
            aws s3api put-bucket-encryption --bucket "$BUCKET_NAME" \
              --server-side-encryption-configuration '{
                "Rules": [{
                  "ApplyServerSideEncryptionByDefault": {
                    "SSEAlgorithm": "AES256"
                  },
                  "BucketKeyEnabled": true
                }]
              }'

            # Block public access
            aws s3api put-public-access-block --bucket "$BUCKET_NAME" \
              --public-access-block-configuration \
                BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true

            # Add lifecycle policy to clean up old versions
            aws s3api put-bucket-lifecycle-configuration --bucket "$BUCKET_NAME" \
              --lifecycle-configuration '{
                "Rules": [{
                  "Id": "DeleteOldVersions",
                  "Status": "Enabled",
                  "NoncurrentVersionExpiration": {
                    "NoncurrentDays": 90
                  }
                }]
              }'

            echo "S3 bucket created and configured successfully"
          fi

      - name: Create DynamoDB table for state locking
        run: |
          TABLE_NAME="portfolio-terraform-locks"
          REGION="${{ secrets.AWS_REGION }}"

          # Check if table exists
          if aws dynamodb describe-table --table-name "$TABLE_NAME" --region "$REGION" 2>/dev/null; then
            echo "DynamoDB table $TABLE_NAME already exists"
          else
            echo "Creating DynamoDB table $TABLE_NAME"

            aws dynamodb create-table \
              --table-name "$TABLE_NAME" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region "$REGION" \
              --tags Key=Project,Value=portfolio Key=Environment,Value=prod Key=ManagedBy,Value=terraform

            # Wait for table to be active
            echo "Waiting for table to be active..."
            aws dynamodb wait table-exists --table-name "$TABLE_NAME" --region "$REGION"

            echo "DynamoDB table created successfully"
          fi

      - name: Summary
        run: |
          echo "âœ… Terraform backend bootstrap complete!"
          echo ""
          echo "Resources created:"
          echo "  - S3 Bucket: portfolio-terraform-state-prod"
          echo "  - DynamoDB Table: portfolio-terraform-locks"
          echo ""
          echo "Next steps:"
          echo "  1. Update backend.tf region to match AWS_REGION secret"
          echo "  2. Commit and push Terraform changes"
          echo "  3. Create a pull request to trigger terraform-plan workflow"
          echo "  4. After PR approval, create a version tag (e.g., v1.0.0) to trigger terraform-apply"
