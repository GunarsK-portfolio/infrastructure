# Terraform Bootstrap Workflow
# Creates S3 bucket for Terraform state storage with S3-native locking
# ONLY run this ONCE before first terraform apply

name: Terraform Bootstrap

on:
  workflow_dispatch:
    inputs:
      confirm_bootstrap:
        description: 'Type "bootstrap" to confirm first-time setup'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  bootstrap:
    name: Bootstrap Terraform Backend
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_bootstrap }}" != "bootstrap" ]; then
            echo "Error: Confirmation required. Type 'bootstrap' to proceed."
            exit 1
          fi

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create S3 bucket for Terraform state
        run: |
          BUCKET_NAME="gunarsk-portfolio-terraform-state-prod"
          REGION="${{ secrets.AWS_REGION }}"

          # Check if bucket exists
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Bucket $BUCKET_NAME already exists"
          else
            echo "Creating S3 bucket $BUCKET_NAME in region $REGION"

            if [ "$REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION"
            else
              aws s3api create-bucket --bucket "$BUCKET_NAME" --region "$REGION" \
                --create-bucket-configuration LocationConstraint="$REGION"
            fi

            # Enable versioning
            aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" \
              --versioning-configuration Status=Enabled

            # Enable encryption
            aws s3api put-bucket-encryption --bucket "$BUCKET_NAME" \
              --server-side-encryption-configuration "{
                \"Rules\": [{
                  \"ApplyServerSideEncryptionByDefault\": {
                    \"SSEAlgorithm\": \"AES256\"
                  },
                  \"BucketKeyEnabled\": true
                }]
              }"

            # Block public access
            aws s3api put-public-access-block --bucket "$BUCKET_NAME" \
              --public-access-block-configuration \
                BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true

            # Add lifecycle policy to clean up old versions
            aws s3api put-bucket-lifecycle-configuration --bucket "$BUCKET_NAME" \
              --lifecycle-configuration "{
                \"Rules\": [{
                  \"Id\": \"DeleteOldVersions\",
                  \"Status\": \"Enabled\",
                  \"NoncurrentVersionExpiration\": {
                    \"NoncurrentDays\": 90
                  },
                  \"Filter\": {
                    \"Prefix\": \"\"
                  }
                }]
              }"

            echo "S3 bucket created and configured successfully"
          fi

      # Note: DynamoDB table NOT needed - backend.tf uses S3-native locking (use_lockfile = true)
      # S3-native locking stores lock file directly in S3 bucket (no DynamoDB charges)

      - name: Summary
        run: |
          echo "âœ… Terraform backend bootstrap complete!"
          echo ""
          echo "Resources created:"
          echo "  - S3 Bucket: gunarsk-portfolio-terraform-state-prod"
          echo "    - Versioning: Enabled"
          echo "    - Encryption: AES256"
          echo "    - Public Access: Blocked"
          echo "    - State Locking: S3-native (use_lockfile=true, no DynamoDB)"
          echo ""
          echo "Next steps:"
          echo "  1. Verify backend.tf region matches AWS_REGION secret (currently: eu-west-1)"
          echo "  2. Commit and push Terraform changes"
          echo "  3. Create a pull request to trigger terraform-plan workflow"
          echo "  4. After PR approval, create a version tag (e.g., v1.0.0) to trigger terraform-apply"
