name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Allow manual trigger

jobs:
  # Job 1: Validate YAML files
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3.1.1
        with:
          file_or_dir: .
          config_file: .yamllint.yml
          strict: true
        continue-on-error: true

  # Job 2: Validate Docker Compose
  docker-compose-validate:
    name: Docker Compose Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate docker-compose.yml syntax
        run: docker compose config --quiet --no-interpolate

  # Job 3: Lint shell scripts
  shellcheck:
    name: Shell Script Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          severity: warning
          scandir: './scripts'
        continue-on-error: true

  # Job 4: Validate Python scripts
  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Install flake8
        run: pip install flake8

      - name: Lint Python scripts
        run: flake8 scripts/ --max-line-length=120 --ignore=E501
        continue-on-error: true

  # Job 5: Security - Check for secrets
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@v3.91.2
        with:
          extra_args: --only-verified

  # Job 6: Markdown lint
  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v21.0.0
        with:
          globs: '**/*.md'
        continue-on-error: true

  # Job 7: Terraform validation and linting
  terraform-lint:
    name: Terraform Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./terraform
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: false

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6
        with:
          tflint_version: latest

      - name: TFLint Init
        run: tflint --init

      - name: Run TFLint
        run: tflint --recursive --format compact

  # Summary job - require all to pass
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [yaml-lint, docker-compose-validate, shellcheck, python-lint, secret-scan, markdown-lint, terraform-lint]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully!"
