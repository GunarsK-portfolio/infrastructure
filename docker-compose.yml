services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:latest
    container_name: traefik
    command:
      # API
      - "--api.dashboard=true"
      - "--api.insecure=true"
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/config"
      - "--providers.file.watch=true"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.admin.address=:81"
      - "--entrypoints.adminsecure.address=:8443"
      - "--entrypoints.swagger.address=:82"
      # HTTP to HTTPS redirect (uncomment for production)
      # - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      # - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Let's Encrypt (uncomment and configure for production)
      # - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      # - "--certificatesresolvers.letsencrypt.acme.email=your-email@example.com"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # Uncomment for Let's Encrypt staging (testing)
      # - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
      - "81:81"      # Admin HTTP
      - "8443:8443"  # Admin HTTPS
      - "82:82"      # Swagger docs
      - "9002:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/certs:/certs:ro
      - ./docker/traefik/dynamic.yml:/config/dynamic.yml:ro
      # - ./docker/traefik/letsencrypt:/letsencrypt  # For Let's Encrypt
    networks:
      - network
    depends_on:
      - public-web
      - admin-web
      - public-api
      - admin-api
      - auth-service

  # Database
  postgres:
    image: postgres:18-alpine
    container_name: postgres
    environment:
      POSTGRES_DB: portfolio
      POSTGRES_USER: portfolio_user
      POSTGRES_PASSWORD: portfolio_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U portfolio_user -d portfolio"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7.4-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO (S3-compatible storage)
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Database Migrations (Flyway)
  flyway:
    image: flyway/flyway:11
    container_name: flyway
    command: migrate
    volumes:
      - ../database/migrations:/flyway/sql
      - ../database/seeds:/flyway/seeds
    environment:
      - FLYWAY_URL=jdbc:postgresql://postgres:5432/portfolio
      - FLYWAY_USER=portfolio_user
      - FLYWAY_PASSWORD=portfolio_pass
      - FLYWAY_BASELINE_ON_MIGRATE=true
      - FLYWAY_LOCATIONS=filesystem:/flyway/sql,filesystem:/flyway/seeds
    networks:
      - network
    depends_on:
      postgres:
        condition: service_healthy

  # Auth Service
  auth-service:
    build:
      context: ../auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    environment:
      - PORT=8084
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=portfolio_user
      - DB_PASSWORD=portfolio_pass
      - DB_NAME=portfolio
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET=your-secret-key-change-in-production
      - JWT_ACCESS_EXPIRY=15m
      - JWT_REFRESH_EXPIRY=168h
    ports:
      - "8084:8084"
    networks:
      - network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      flyway:
        condition: service_completed_successfully
    labels:
      - "traefik.enable=true"
      # HTTP router - rewrite /auth/v1/* to /api/v1/auth/*
      - "traefik.http.routers.auth-api.rule=PathPrefix(`/auth/v1/`)"
      - "traefik.http.routers.auth-api.entrypoints=admin"
      - "traefik.http.routers.auth-api.middlewares=auth-rewrite"
      - "traefik.http.routers.auth-api.priority=100"
      - "traefik.http.routers.auth-api.service=auth-api"
      # HTTPS router
      - "traefik.http.routers.auth-api-secure.rule=PathPrefix(`/auth/v1/`)"
      - "traefik.http.routers.auth-api-secure.entrypoints=adminsecure"
      - "traefik.http.routers.auth-api-secure.middlewares=auth-rewrite"
      - "traefik.http.routers.auth-api-secure.priority=100"
      - "traefik.http.routers.auth-api-secure.tls=true"
      - "traefik.http.routers.auth-api-secure.service=auth-api"
      # Middleware and service
      - "traefik.http.middlewares.auth-rewrite.replacepathregex.regex=^/auth/v1/(.*)"
      - "traefik.http.middlewares.auth-rewrite.replacepathregex.replacement=/api/v1/auth/$$1"
      - "traefik.http.services.auth-api.loadbalancer.server.port=8084"
      # Swagger docs
      - "traefik.http.routers.auth-swagger.rule=PathPrefix(`/auth/`)"
      - "traefik.http.routers.auth-swagger.entrypoints=swagger"
      - "traefik.http.routers.auth-swagger.middlewares=auth-swagger-strip"
      - "traefik.http.middlewares.auth-swagger-strip.stripprefix.prefixes=/auth"

  # Public API
  public-api:
    build:
      context: ../public-api
      dockerfile: Dockerfile
    container_name: public-api
    environment:
      - PORT=8082
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=portfolio_user
      - DB_PASSWORD=portfolio_pass
      - DB_NAME=portfolio
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET=images
      - S3_USE_SSL=false
    ports:
      - "8082:8082"
    networks:
      - network
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      flyway:
        condition: service_completed_successfully
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.public-api.rule=PathPrefix(`/api/`)"
      - "traefik.http.routers.public-api.entrypoints=web"
      # HTTPS router
      - "traefik.http.routers.public-api-secure.rule=PathPrefix(`/api/`)"
      - "traefik.http.routers.public-api-secure.entrypoints=websecure"
      - "traefik.http.routers.public-api-secure.tls=true"
      - "traefik.http.routers.public-api-secure.service=public-api"
      - "traefik.http.services.public-api.loadbalancer.server.port=8082"
      # Swagger docs
      - "traefik.http.routers.public-swagger.rule=PathPrefix(`/public/`)"
      - "traefik.http.routers.public-swagger.entrypoints=swagger"
      - "traefik.http.routers.public-swagger.middlewares=public-swagger-strip"
      - "traefik.http.middlewares.public-swagger-strip.stripprefix.prefixes=/public"

  # Admin API
  admin-api:
    build:
      context: ../admin-api
      dockerfile: Dockerfile
    container_name: admin-api
    environment:
      - PORT=8083
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=portfolio_user
      - DB_PASSWORD=portfolio_pass
      - DB_NAME=portfolio
      - AUTH_SERVICE_URL=http://auth-service:8084
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESS_KEY=minioadmin
      - S3_SECRET_KEY=minioadmin
      - S3_BUCKET=images
      - S3_USE_SSL=false
    ports:
      - "8083:8083"
    networks:
      - network
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      auth-service:
        condition: service_started
      flyway:
        condition: service_completed_successfully
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.admin-api.rule=PathPrefix(`/api/`)"
      - "traefik.http.routers.admin-api.entrypoints=admin"
      # HTTPS router
      - "traefik.http.routers.admin-api-secure.rule=PathPrefix(`/api/`)"
      - "traefik.http.routers.admin-api-secure.entrypoints=adminsecure"
      - "traefik.http.routers.admin-api-secure.tls=true"
      - "traefik.http.routers.admin-api-secure.service=admin-api"
      - "traefik.http.services.admin-api.loadbalancer.server.port=8083"
      # Swagger docs
      - "traefik.http.routers.admin-swagger.rule=PathPrefix(`/admin/`)"
      - "traefik.http.routers.admin-swagger.entrypoints=swagger"
      - "traefik.http.routers.admin-swagger.middlewares=admin-swagger-strip"
      - "traefik.http.middlewares.admin-swagger-strip.stripprefix.prefixes=/admin"

  # Public Web
  public-web:
    build:
      context: ../public-web
      dockerfile: Dockerfile
    container_name: public-web
    environment:
      - VITE_API_URL=https://localhost/api/v1
    ports:
      - "8080:80"
    networks:
      - network
    depends_on:
      - public-api
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.public-web.rule=PathPrefix(`/`)"
      - "traefik.http.routers.public-web.entrypoints=web"
      - "traefik.http.routers.public-web.priority=1"
      # HTTPS router
      - "traefik.http.routers.public-web-secure.rule=PathPrefix(`/`)"
      - "traefik.http.routers.public-web-secure.entrypoints=websecure"
      - "traefik.http.routers.public-web-secure.priority=1"
      - "traefik.http.routers.public-web-secure.tls=true"
      - "traefik.http.routers.public-web-secure.service=public-web"
      - "traefik.http.services.public-web.loadbalancer.server.port=80"

  # Admin Web
  admin-web:
    build:
      context: ../admin-web
      dockerfile: Dockerfile
    container_name: admin-web
    environment:
      - VITE_API_URL=https://localhost:8443/api/v1
      - VITE_AUTH_URL=https://localhost:8443/auth/v1
    ports:
      - "8081:80"
    networks:
      - network
    depends_on:
      - admin-api
      - auth-service
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.admin-web.rule=PathPrefix(`/`)"
      - "traefik.http.routers.admin-web.entrypoints=admin"
      - "traefik.http.routers.admin-web.priority=1"
      # HTTPS router
      - "traefik.http.routers.admin-web-secure.rule=PathPrefix(`/`)"
      - "traefik.http.routers.admin-web-secure.entrypoints=adminsecure"
      - "traefik.http.routers.admin-web-secure.priority=1"
      - "traefik.http.routers.admin-web-secure.tls=true"
      - "traefik.http.routers.admin-web-secure.service=admin-web"
      - "traefik.http.services.admin-web.loadbalancer.server.port=80"

networks:
  network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  minio_data: