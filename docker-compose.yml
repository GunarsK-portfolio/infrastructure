services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v3.5.3
    container_name: traefik
    restart: unless-stopped
    command:
      # API
      - "--api.dashboard=true"
      - "--api.insecure=false"
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/config"
      - "--providers.file.watch=true"
      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.admin.address=:81"
      - "--entrypoints.adminsecure.address=:8443"
      - "--entrypoints.swagger.address=:82"
      # HTTP to HTTPS redirect (uncomment for production)
      # - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      # - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      # Let's Encrypt (uncomment and configure for production)
      # - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      # - "--certificatesresolvers.letsencrypt.acme.email=your-email@example.com"
      # - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      # Uncomment for Let's Encrypt staging (testing)
      # - "--certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
    ports:
      - "80:80"      # HTTP
      - "443:443"    # HTTPS
      - "81:81"      # Admin HTTP
      - "8443:8443"  # Admin HTTPS
      - "82:82"      # Swagger docs
      - "9002:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${TRAEFIK_CERT_DIR}:/certs:ro
      - ./docker/traefik/dynamic.yml:/config/dynamic.yml:ro
      # - ./docker/traefik/letsencrypt:/letsencrypt  # For Let's Encrypt
    networks:
      - network
    depends_on:
      - public-web
      - admin-web
      - public-api
      - admin-api
      - auth-service
      - files-api
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  # Database
  postgres:
    image: ghcr.io/gunarsk-portfolio/postgres-image:latest
    container_name: postgres
    restart: unless-stopped
    command:
      - "postgres"
      - "-c"
      - "shared_preload_libraries=pg_stat_statements,pg_cron"
      - "-c"
      - "cron.database_name=portfolio"
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      # Default PostgreSQL superuser (creates database and initial users)
      POSTGRES_USER: ${POSTGRES_SUPERUSER}
      POSTGRES_PASSWORD: ${POSTGRES_SUPERUSER_PASSWORD}
      # User credentials for envsubst in init script
      FLYWAY_USER: ${FLYWAY_USER}
      FLYWAY_PASSWORD: ${FLYWAY_PASSWORD}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_USER_READONLY: ${DB_USER_READONLY}
      DB_PASSWORD_READONLY: ${DB_PASSWORD_READONLY}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Bootstrap users before Flyway runs
      # Extensions are automatically created by postgres-image's init-extensions.sql
      - ./docker/postgres/init-users.sh:/docker-entrypoint-initdb.d/01-init-users.sh:ro
      - ./docker/postgres/init-users.sql.template:/docker-entrypoint-initdb.d/init-users.sql.template:ro
    networks:
      - network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d portfolio"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # Redis Cache
  redis:
    image: redis:8.2-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # MinIO (S3-compatible storage)
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    networks:
      - network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # MinIO Bucket Setup
  minio-setup:
    image: minio/mc:RELEASE.2025-08-13T08-35-41Z
    container_name: minio-setup
    restart: "no"
    volumes:
      - ./docker/minio/files-api-policy.json:/policies/files-api-policy.json:ro
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio ${S3_ENDPOINT} ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
      /usr/bin/mc mb --ignore-existing myminio/images;
      /usr/bin/mc mb --ignore-existing myminio/miniatures;
      /usr/bin/mc mb --ignore-existing myminio/documents;
      /usr/bin/mc admin policy create myminio files-api-policy /policies/files-api-policy.json;
      /usr/bin/mc admin user add myminio ${S3_ACCESS_KEY} ${S3_SECRET_KEY};
      /usr/bin/mc admin policy attach myminio files-api-policy --user ${S3_ACCESS_KEY};
      exit 0;
      "
    networks:
      - network
    depends_on:
      minio:
        condition: service_healthy

  # Database Migrations (Flyway)
  flyway:
    image: flyway/flyway:11
    container_name: flyway
    restart: "no"
    command: migrate
    volumes:
      - ../database/migrations:/flyway/sql
      - ../database/seeds:/flyway/seeds
    environment:
      - FLYWAY_URL=jdbc:postgresql://${DB_HOST}:${DB_PORT}/${POSTGRES_DB}
      # Use portfolio_owner for migrations (has DDL rights)
      - FLYWAY_USER=${FLYWAY_USER}
      - FLYWAY_PASSWORD=${FLYWAY_PASSWORD}
      - FLYWAY_BASELINE_ON_MIGRATE=${FLYWAY_BASELINE_ON_MIGRATE}
      - FLYWAY_LOCATIONS=${FLYWAY_LOCATIONS}
    networks:
      - network
    depends_on:
      postgres:
        condition: service_healthy

  # Auth Service
  auth-service:
    build:
      context: ../auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    restart: unless-stopped
    environment:
      - PORT=${AUTH_SERVICE_PORT}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      # Use portfolio_admin for runtime (CRUD only, no DDL)
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${POSTGRES_DB}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_EXPIRY=${JWT_ACCESS_EXPIRY}
      - JWT_REFRESH_EXPIRY=${JWT_REFRESH_EXPIRY}
    ports:
      - "8084:8084"
    networks:
      - network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      flyway:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    labels:
      - "traefik.enable=true"
      # HTTP router - rewrite /auth/v1/* to /api/v1/auth/*
      - "traefik.http.routers.auth-api.rule=PathPrefix(`/auth/v1/`)"
      - "traefik.http.routers.auth-api.entrypoints=admin"
      - "traefik.http.routers.auth-api.middlewares=auth-rewrite"
      - "traefik.http.routers.auth-api.priority=100"
      - "traefik.http.routers.auth-api.service=auth-api"
      # HTTPS router
      - "traefik.http.routers.auth-api-secure.rule=PathPrefix(`/auth/v1/`)"
      - "traefik.http.routers.auth-api-secure.entrypoints=adminsecure"
      - "traefik.http.routers.auth-api-secure.middlewares=auth-rewrite"
      - "traefik.http.routers.auth-api-secure.priority=100"
      - "traefik.http.routers.auth-api-secure.tls=true"
      - "traefik.http.routers.auth-api-secure.service=auth-api"
      # Middleware and service
      - "traefik.http.middlewares.auth-rewrite.replacepathregex.regex=^/auth/v1/(.*)"
      - "traefik.http.middlewares.auth-rewrite.replacepathregex.replacement=/api/v1/auth/$$1"
      - "traefik.http.services.auth-api.loadbalancer.server.port=8084"
      # Swagger docs
      - "traefik.http.routers.auth-swagger.rule=PathPrefix(`/auth/`)"
      - "traefik.http.routers.auth-swagger.entrypoints=swagger"
      - "traefik.http.routers.auth-swagger.middlewares=auth-swagger-strip"
      - "traefik.http.middlewares.auth-swagger-strip.stripprefix.prefixes=/auth"

  # Public API
  public-api:
    build:
      context: ../public-api
      dockerfile: Dockerfile
    container_name: public-api
    restart: unless-stopped
    environment:
      - PORT=${PUBLIC_API_PORT}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      # Use portfolio_public for public API (SELECT only for extra security)
      - DB_USER=${DB_USER_READONLY}
      - DB_PASSWORD=${DB_PASSWORD_READONLY}
      - DB_NAME=${POSTGRES_DB}
      - FILES_API_URL=${FILES_API_URL}
    ports:
      - "8082:8082"
    networks:
      - network
    depends_on:
      postgres:
        condition: service_healthy
      files-api:
        condition: service_started
      flyway:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.public-api.rule=PathPrefix(`/api/`)"
      - "traefik.http.routers.public-api.entrypoints=web"
      - "traefik.http.routers.public-api.priority=100"
      - "traefik.http.routers.public-api.service=public-api"
      # HTTPS router
      - "traefik.http.routers.public-api-secure.rule=PathPrefix(`/api/`)"
      - "traefik.http.routers.public-api-secure.entrypoints=websecure"
      - "traefik.http.routers.public-api-secure.priority=100"
      - "traefik.http.routers.public-api-secure.tls=true"
      - "traefik.http.routers.public-api-secure.service=public-api"
      - "traefik.http.services.public-api.loadbalancer.server.port=8082"
      # Swagger docs
      - "traefik.http.routers.public-swagger.rule=PathPrefix(`/public/`)"
      - "traefik.http.routers.public-swagger.entrypoints=swagger"
      - "traefik.http.routers.public-swagger.middlewares=public-swagger-strip"
      - "traefik.http.middlewares.public-swagger-strip.stripprefix.prefixes=/public"

  # Admin API
  admin-api:
    build:
      context: ../admin-api
      dockerfile: Dockerfile
    container_name: admin-api
    restart: unless-stopped
    environment:
      - PORT=${ADMIN_API_PORT}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      # Use portfolio_admin for admin API (CRUD access)
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${POSTGRES_DB}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - FILES_API_URL=${FILES_API_URL}
    ports:
      - "8083:8083"
    networks:
      - network
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      auth-service:
        condition: service_started
      files-api:
        condition: service_started
      flyway:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    labels:
      - "traefik.enable=true"
      # HTTP router - rewrite /admin-api/v1/* to /api/v1/*
      - "traefik.http.routers.admin-api.rule=PathPrefix(`/admin-api/`)"
      - "traefik.http.routers.admin-api.entrypoints=admin"
      - "traefik.http.routers.admin-api.middlewares=admin-api-rewrite"
      - "traefik.http.routers.admin-api.priority=100"
      - "traefik.http.routers.admin-api.service=admin-api"
      # HTTPS router
      - "traefik.http.routers.admin-api-secure.rule=PathPrefix(`/admin-api/`)"
      - "traefik.http.routers.admin-api-secure.entrypoints=adminsecure"
      - "traefik.http.routers.admin-api-secure.middlewares=admin-api-rewrite"
      - "traefik.http.routers.admin-api-secure.priority=100"
      - "traefik.http.routers.admin-api-secure.tls=true"
      - "traefik.http.routers.admin-api-secure.service=admin-api"
      # Middleware and service
      - "traefik.http.middlewares.admin-api-rewrite.replacepathregex.regex=^/admin-api/(.*)"
      - "traefik.http.middlewares.admin-api-rewrite.replacepathregex.replacement=/api/$$1"
      - "traefik.http.services.admin-api.loadbalancer.server.port=8083"
      # Swagger docs
      - "traefik.http.routers.admin-swagger.rule=PathPrefix(`/admin/`)"
      - "traefik.http.routers.admin-swagger.entrypoints=swagger"
      - "traefik.http.routers.admin-swagger.middlewares=admin-swagger-strip"
      - "traefik.http.middlewares.admin-swagger-strip.stripprefix.prefixes=/admin"

  # Files API
  files-api:
    build:
      context: ../files-api
      dockerfile: Dockerfile
    container_name: files-api
    restart: unless-stopped
    environment:
      - PORT=${FILES_API_PORT}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      # Use portfolio_admin for files API (needs write access to storage.files)
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_NAME=${POSTGRES_DB}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_USE_SSL=${S3_USE_SSL}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE}
      - ALLOWED_FILE_TYPES=${ALLOWED_FILE_TYPES}
    ports:
      - "8085:8085"
    networks:
      - network
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      flyway:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    labels:
      - "traefik.enable=true"
      # HTTP router - files accessible on both public and admin
      - "traefik.http.routers.files-api.rule=PathPrefix(`/files/`)"
      - "traefik.http.routers.files-api.entrypoints=web,admin"
      - "traefik.http.routers.files-api.priority=110"
      - "traefik.http.routers.files-api.service=files-api"
      # HTTPS router
      - "traefik.http.routers.files-api-secure.rule=PathPrefix(`/files/`)"
      - "traefik.http.routers.files-api-secure.entrypoints=websecure,adminsecure"
      - "traefik.http.routers.files-api-secure.priority=110"
      - "traefik.http.routers.files-api-secure.tls=true"
      - "traefik.http.routers.files-api-secure.service=files-api"
      - "traefik.http.services.files-api.loadbalancer.server.port=8085"
      # Swagger docs
      - "traefik.http.routers.files-swagger.rule=PathPrefix(`/files/`)"
      - "traefik.http.routers.files-swagger.entrypoints=swagger"
      - "traefik.http.routers.files-swagger.middlewares=files-swagger-strip"
      - "traefik.http.middlewares.files-swagger-strip.stripprefix.prefixes=/files"

  # Public Web
  public-web:
    build:
      context: ../public-web
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_PUBLIC_API_URL}
        VITE_USE_MOCK_DATA: ${VITE_PUBLIC_USE_MOCK_DATA}
    container_name: public-web
    restart: unless-stopped
    ports:
      - "8080:80"
    networks:
      - network
    depends_on:
      - public-api
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.public-web.rule=PathPrefix(`/`) && !PathPrefix(`/api/`)"
      - "traefik.http.routers.public-web.entrypoints=web"
      - "traefik.http.routers.public-web.priority=1"
      # HTTPS router
      - "traefik.http.routers.public-web-secure.rule=PathPrefix(`/`) && !PathPrefix(`/api/`)"
      - "traefik.http.routers.public-web-secure.entrypoints=websecure"
      - "traefik.http.routers.public-web-secure.priority=1"
      - "traefik.http.routers.public-web-secure.tls=true"
      - "traefik.http.routers.public-web-secure.service=public-web"
      - "traefik.http.services.public-web.loadbalancer.server.port=80"

  # Admin Web
  admin-web:
    build:
      context: ../admin-web
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_ADMIN_API_URL}
        VITE_AUTH_URL: ${VITE_ADMIN_AUTH_URL}
    container_name: admin-web
    restart: unless-stopped
    ports:
      - "8081:80"
    networks:
      - network
    depends_on:
      - admin-api
      - auth-service
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.admin-web.rule=PathPrefix(`/`)"
      - "traefik.http.routers.admin-web.entrypoints=admin"
      - "traefik.http.routers.admin-web.priority=1"
      # HTTPS router
      - "traefik.http.routers.admin-web-secure.rule=PathPrefix(`/`)"
      - "traefik.http.routers.admin-web-secure.entrypoints=adminsecure"
      - "traefik.http.routers.admin-web-secure.priority=1"
      - "traefik.http.routers.admin-web-secure.tls=true"
      - "traefik.http.routers.admin-web-secure.service=admin-web"
      - "traefik.http.services.admin-web.loadbalancer.server.port=80"

networks:
  network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  minio_data:
